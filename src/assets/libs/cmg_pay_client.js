var P,b=exports&&exports.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,f){m.__proto__=f}||function(m,f){for(var a in f)f.hasOwnProperty(a)&&(m[a]=f[a])};return function(m,f){function a(){this.constructor=m}t(m,f),m.prototype=f===null?Object.create(f):(a.prototype=f.prototype,new a)}}();(function(t){var m=function(){function a(){}return a.SUCESS=0,a.NOT_INIT=-1,a.PARAMETER_INVALIDATE=-2,a.SERVER_NET_ERROR=-3,a.SERVER_ERROR_PRE_TRADE=-4,a.SERVER_ERROR_PAY=-5,a.SERVER_ERROR_PERPAY=-6,a.MIDAS_ERROR=-7,a.SERVER_ERROR_CHECK_BALANCE=-8,a.SERVER_ERROR_CHECK_BALANCE_MISMATCH=-9,a.SERVER_ERROR_BUY_HONOR_NOT_EXIST=-10,a}();t.ClientPayCode=m;var f=function(){function a(){}return a.prototype.init=function(e,r,n,o,u,c){c===void 0&&(c=!1),c&&(r=t.Platform.PLATFORM_WECHAT_TEST,t.Platform.isPrintLog=!0),t.Platform.log("Client::init gameId("+e+") platform("+r+")"),this.mDataManager=new t.PayManager(e,r,n,o),this.mDataManager.init(u)},a.prototype.consume=function(e,r,n,o){this.mDataManager!=null?this.mDataManager.consume(e,r,n,o):o(m.NOT_INIT,null)},a.prototype.present=function(e,r,n,o){this.mDataManager!=null?this.mDataManager.present(e,r,n,o):o(m.NOT_INIT,null)},a.prototype.getBalance=function(e){this.mDataManager!=null?this.mDataManager.getBalance(e):e(m.NOT_INIT,null)},a.prototype.recharge=function(e,r){this.mDataManager!=null?this.mDataManager.recharge(e,r):r(t.RechargeResponse.create(t.RechargeStage.PERPAY,m.NOT_INIT))},a.prototype.getHistroyTrade=function(e,r,n){this.mDataManager!=null?this.mDataManager.getHistroyTrade(e,r,n):n(m.NOT_INIT,null)},a.prototype.buyHonor=function(e,r){this.mDataManager!=null?this.mDataManager.buyHonor(e,r):r(m.NOT_INIT,null)},a.prototype.destroy=function(e){t.Platform.log("Client::destroy"),this.mDataManager&&this.mDataManager.destroy(e)},a}();t.Client=f,t.client=new f})(P||(P={})),function(t){var m=function(){function r(){}return r.PERPAY="request_perpay",r.PAY="request_pay",r.CHECK_PAY="request_check_pay",r}();t.RechargeStage=m;var f=function(){function r(){}return r.prototype.isUserCancel=function(){return this.midasErrCode!=null&&(this.midasErrCode==-2||this.midasErrCode==1)},r.create=function(n,o,u){var c=new r;return c.stage=n,c.resultCode=o,c.result=o==t.ClientPayCode.SUCESS,c.balancInfo=u,c},r.createMidas=function(n,o,u){var c=new r;return c.stage=m.PAY,c.resultCode=n,c.result=n==t.ClientPayCode.SUCESS,c.midasErrMsg=o,c.midasErrCode=u,c},r}();t.RechargeResponse=f;var a=function(){function r(){}return r.createSimpleBalance=function(n){var o=new r;return o.balance=n,o},r.parseServerJson=function(n){var o=new r;return o.balance=n.balance,o.presentedBalance=n.gen_balance,o.firstPay=n.first_save,o.paySum=n.save_amt,o.totalSum=n.save_sum,o.costSum=n.cost_sum,o.presentSum=n.present_sum,o},r.prototype.toString=function(){return console.log("toString called "),""},r}();t.BalanceInfo=a;var e=function(){function r(){}return r.parseServerJson=function(n){try{return a.parseServerJson(n)}catch(o){t.Platform.error(o)}return null},r}();t.BalanceInfoParser=e}((window.cmgPay=P)||(P={})),function(t){var m=function(){function f(a,e,r,n){this.mOfferId="1450015698",this.mPlatform=t.Platform.createInstance(a,e,r,n),this.mNetRequester=new t.PayNetRequester(this.mPlatform)}return f.prototype.init=function(a){a(t.ClientPayCode.SUCESS)},f.prototype.destroy=function(a){a(t.ClientPayCode.SUCESS)},f.prototype.consume=function(a,e,r,n){var o=this;this.mNetRequester.pretrade(function(u,c){u==t.ClientPayCode.SUCESS?o.mNetRequester.pay(c,a,e,r,function(y,g){y==t.ClientPayCode.SUCESS?n(y,t.BalanceInfo.createSimpleBalance(g)):n(t.ClientPayCode.SERVER_ERROR_PAY,null)}):n(t.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.present=function(a,e,r,n){var o=this;this.mNetRequester.pretrade(function(u,c){u==t.ClientPayCode.SUCESS?o.mNetRequester.present(c,a,e,r,function(y,g){y==t.ClientPayCode.SUCESS?n(y,t.BalanceInfo.createSimpleBalance(g)):n(t.ClientPayCode.SERVER_ERROR_PAY,null)}):n(t.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.getBalance=function(a){this.mNetRequester.getBalance(a)},f.prototype.recharge=function(a,e){var r=this,n=this.getLocalBillNo();this.mNetRequester.perpay(n,a,function(o,u,c,y){o==t.ClientPayCode.SUCESS?(t.Platform.log("perpay: localBillNo "+u+", serverBillNo: "+c+", balance: "+y),e(t.RechargeResponse.create(t.RechargeStage.PERPAY,t.ClientPayCode.SUCESS)),r.requestMidasPayment(a,y,e)):e(t.RechargeResponse.create(t.RechargeStage.PERPAY,t.ClientPayCode.SERVER_ERROR_PERPAY))})},f.prototype.getLocalBillNo=function(){return"midas-"+new Date().getTime()},f.prototype.requestMidasPayment=function(a,e,r){var n=this,o={mode:"game",offerId:this.mOfferId,buyQuantity:a,zoneId:"1",platform:"android",env:0,currencyType:"CNY",success:function(){t.Platform.log("requestMidasPayment success "),r(t.RechargeResponse.createMidas(t.ClientPayCode.SUCESS)),n.checkBalance(e,r)},fail:function(u){var c=u.errMsg,y=u.errCode;t.Platform.log("requestMidasPayment fail"),console.error(c,y),r(t.RechargeResponse.createMidas(t.ClientPayCode.MIDAS_ERROR,c,y))},complete:function(){t.Platform.log("requestMidasPayment complete called ")}};t.Platform.log("requestMidasPayment called!!!! "),t.Platform.log(o);try{wx.requestMidasPayment(o)}catch(u){t.Platform.log("wx.requestMidasPayment catch e "),r(t.RechargeResponse.createMidas(t.ClientPayCode.MIDAS_ERROR,"requestMidasPayment catch error",-19800)),t.Platform.log(u)}t.Platform.log("requestMidasPayment called end !!!! ")},f.prototype.checkBalance=function(a,e){this.mNetRequester.getBalance(function(r,n){r==t.ClientPayCode.SUCESS?(t.Platform.log("checkBalance success preBlance: "+a+", current blance: "+n.balance),n.preBalance=a,n.balance<=a?e(t.RechargeResponse.create(t.RechargeStage.CHECK_PAY,t.ClientPayCode.SERVER_ERROR_CHECK_BALANCE_MISMATCH,n)):e(t.RechargeResponse.create(t.RechargeStage.CHECK_PAY,t.ClientPayCode.SUCESS,n))):e(t.RechargeResponse.create(t.RechargeStage.CHECK_PAY,t.ClientPayCode.SERVER_ERROR_CHECK_BALANCE))})},f.prototype.getHistroyTrade=function(a,e,r){this.mNetRequester.getHistroyTrade(a,e,r)},f.prototype.buyHonor=function(a,e){this.mNetRequester.buyHonor(a,e)},f}();t.PayManager=m}(P||(P={})),function(t){var m=function(){function f(a){this.urlPerpay="payment/midas/prepay",this.urlGetBalance="payment/midas/balance/get",this.urlPretrade="payment/midas/pretrade",this.urlPay="payment/midas/pay",this.urlGetHistoryTrade="payment/midas/trade_history",this.urlPresent="payment/midas/present",this.urlBuyHonor="userinfo/honor/buy",this.mPlatform=a,this.urlPerpay=this.mPlatform.getBaseServerUrl()+this.urlPerpay,this.urlGetBalance=this.mPlatform.getBaseServerUrl()+this.urlGetBalance,this.urlPretrade=this.mPlatform.getBaseServerUrl()+this.urlPretrade,this.urlPay=this.mPlatform.getBaseServerUrl()+this.urlPay,this.urlGetHistoryTrade=this.mPlatform.getBaseServerUrl()+this.urlGetHistoryTrade,this.urlPresent=this.mPlatform.getBaseServerUrl()+this.urlPresent,this.urlBuyHonor=this.mPlatform.getBaseServerUrl()+this.urlBuyHonor}return f.prototype.perpay=function(a,e,r){var n={local_bill_no:a,amount:e};this.mPlatform.netwrokRequest(this.urlPerpay,n,function(o,u){t.Platform.log("PayNetRequester#perpay#result: "+o),t.Platform.log(u);var c=o?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;o&&u!=null&&u.local_bill_no==a&&u.bill_no!=0?r(c,u.local_bill_no,u.bill_no,u.balance):r(t.ClientPayCode.SERVER_NET_ERROR,a,"",0)})},f.prototype.getBalance=function(a){this.mPlatform.netwrokRequest(this.urlGetBalance,{},function(e,r){t.Platform.log("PayNetRequester#getBalance#result: "+e),t.Platform.log(r);var n=e?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;if(e&&r!=null){var o=t.BalanceInfoParser.parseServerJson(r);o!=null?a(n,o):a(t.ClientPayCode.SERVER_NET_ERROR,null)}else a(t.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pretrade=function(a){this.mPlatform.netwrokRequest(this.urlPretrade,{},function(e,r){t.Platform.log("PayNetRequester#pretrade#result: "+e),t.Platform.log(r);var n=e?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;e&&r!=null&&r.bill_no!=null?a(n,r.bill_no):a(t.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pay=function(a,e,r,n,o){var u={amt:e,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPay,u,function(c,y){t.Platform.log("PayNetRequester#pay#result: "+c),t.Platform.log(y);var g=c?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;c&&y!=null&&y.balance!=null?o(g,y.balance):o(t.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.present=function(a,e,r,n,o){var u={amt:e,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPresent,u,function(c,y){t.Platform.log("PayNetRequester#present#result: "+c),t.Platform.log(y);var g=c?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;c&&y!=null&&y.balance!=null?o(g,y.balance):o(t.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.getHistroyTrade=function(a,e,r){var n={begin_time:Math.floor(a/1e3),end_time:Math.floor(e/1e3)};this.mPlatform.netwrokRequest(this.urlGetHistoryTrade,n,function(o,u){t.Platform.log("PayNetRequester#getHistroyTrade#result: "+o),t.Platform.log(u);var c=o?t.ClientPayCode.SUCESS:t.ClientPayCode.SERVER_NET_ERROR;o&&u!=null?r(c,0):r(t.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.buyHonor=function(a,e){var r={item_id:a};this.mPlatform.netwrokRequest(this.urlBuyHonor,r,function(n,o){if(t.Platform.log("PayNetRequester#buyHonor#result: "+n),t.Platform.log(o),o&&o.status){var u=null;if(o.infos)try{u=JSON.parse(o.infos)}catch(A){}if(!u)return t.Platform.log("PayNetRequester#buyHonor#dataInfo parse error"),void e(o.status,null);var c=new Map;for(var y in u)u.hasOwnProperty(y)&&(g=u[y])!=null&&c.set(y,g);var g,d=o.status;d==t.ClientPayCode.SUCESS&&((g=c.get(a))==null||g==null||g<=0)&&(t.Platform.log("PayNetRequester#buyHonor#cannot find itemId"),d=t.ClientPayCode.SERVER_ERROR_BUY_HONOR_NOT_EXIST),e(d,c)}else e(t.ClientPayCode.SERVER_NET_ERROR,null)})},f}();t.PayNetRequester=m}(P||(P={})),function(t){var m=function(){function e(){var r=window.getQueryStringRegion("region");this.SERVER_ADDRESS_BASE=r=="oversea"?"https://h5game_oversea.cmcm.com/warty/":"https://minigame.cmcm.com/warty/"}return e.prototype.networkRequest=function(r){t.WXHelper.networkRequest(r)},e.prototype.getBaseServerUrl=function(){return this.SERVER_ADDRESS_BASE},e.prototype.getStorageSync=function(r){return t.WXHelper.getStorageSync(r)},e.prototype.setStorageSync=function(r,n){t.WXHelper.setStorageSync(r,n)},e}(),f=function(e){function r(){return e!==null&&e.apply(this,arguments)||this}return b(r,e),r.prototype.getBaseServerUrl=function(){return"https://pianotiles-minigame.cmcm.com/warty/"},r}(m),a=function(){function e(r,n,o,u){this.mTimeDiffLocal=0,this.mPlatformType=n,this.mGameId=r,this.mPlayerId=o,this.mToken=u,this.initPlatform(this.mPlatformType)}return e.createInstance=function(r,n,o,u){return new e(r,n,o,u)},e.log=function(r){e.isPrintLog&&console.warn(r)},e.error=function(r){console.error(r)},e.prototype.initPlatform=function(r){switch(r){case e.PLATFORM_WECHAT:case e.PLATFORM_H5SDK:this.mPlatformProxy=new m;break;case e.PLATFORM_WECHAT_TEST:default:this.mPlatformProxy=new f}},e.prototype.getBaseServerUrl=function(){return this.mPlatformProxy.getBaseServerUrl()},e.prototype.netwrokRequest=function(r,n,o,u){var c=this;u===void 0&&(u=e.IO_TRY_TIMES_MAX),e.log("#### netwrokRequest tryTime "+u),n.playerid=this.mPlayerId,n.timestamp=new Date().getTime(),n.gameid=this.mGameId;var y="CMCM "+t.hex_hmac_sha1(this.mToken,JSON.stringify(n));this.doNetworkRequest({url:r,data:n,header:{Authorization:y},method:e.METHOD_POST,dataType:"string",callback:function(g,d){u-=1,g==0&&0<u?c.netwrokRequest(r,n,o,u):o(g,d)}})},e.prototype.getCurrentServerTime=function(){var r=new Date().getTime()-this.mTimeDiffLocal;return e.log("getServerTime:"+r),r},e.prototype.refleshLocalTimeDiff=function(r){this.mTimeDiffLocal=new Date().getTime()-r},e.prototype.doNetworkRequest=function(r){var n=this;this.mPlatformProxy.networkRequest({url:r.url,data:r.data,header:r.header,method:r.method,dataType:r.dataType,callback:function(o,u,c,y){var g=null;if(o){g=JSON.parse(u),n.refleshLocalTimeDiff(1e3*g.timestamp);var d=y.Authorization?y.Authorization:y.authorization;if(!y||!d)return e.error("networkRequest, fail: Authorization is empty."),void r.callback(!1,g);var A=n.mToken;if(!A)return e.error("networkRequest, Local token is empty"),void r.callback(!1,null);if("CMCM "+t.hex_hmac_sha1(A,u)!==d)return e.error("networkRequest, fail: Invalid authorization."),void r.callback(!1,null);e.log("networkRequest, The authorization is right.")}r.callback(o,g)}})},e.prototype.getLocalStorage=function(r){for(var n=0;n<e.IO_TRY_TIMES_MAX;n++)try{return this.mPlatformProxy.getStorageSync(r)}catch(o){e.error(o)}},e.prototype.setLocalStorage=function(r,n){for(var o=0;o<e.IO_TRY_TIMES_MAX;o++)try{return this.mPlatformProxy.setStorageSync(r,n)}catch(u){e.error(u)}},e.PLATFORM_WEB=0,e.PLATFORM_WECHAT=1,e.PLATFORM_FACEBOOK=2,e.PLATFORM_H5SDK=3,e.PLATFORM_QQPLAY=4,e.PLATFORM_WECHAT_TEST=101,e.isPrintLog=!0,e.METHOD_POST="POST",e.IO_TRY_TIMES_MAX=3,e}();t.Platform=a}(P||(P={})),function(t){var m=0,f="";function a(s){return n(e(c(s)))}function e(s){return g(d(y(s),8*s.length))}function r(s,l){var i=y(s);16<i.length&&(i=d(i,8*s.length));for(var R=Array(16),h=Array(16),p=0;p<16;p++)R[p]=909522486^i[p],h[p]=1549556828^i[p];var E=d(R.concat(y(l)),512+8*l.length);return g(d(h.concat(E),672))}function n(s){for(var l,i=m?"0123456789ABCDEF":"0123456789abcdef",R="",h=0;h<s.length;h++)l=s.charCodeAt(h),R+=i.charAt(l>>>4&15)+i.charAt(15&l);return R}function o(s){for(var l="",i=s.length,R=0;R<i;R+=3)for(var h=s.charCodeAt(R)<<16|(R+1<i?s.charCodeAt(R+1)<<8:0)|(R+2<i?s.charCodeAt(R+2):0),p=0;p<4;p++)8*R+6*p>8*s.length?l+=f:l+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(h>>>6*(3-p)&63);return l}function u(s,l){var i,R,h,p,E=l.length,C=Array(),S=Array(Math.ceil(s.length/2));for(i=0;i<S.length;i++)S[i]=s.charCodeAt(2*i)<<8|s.charCodeAt(2*i+1);for(;0<S.length;){for(p=Array(),i=h=0;i<S.length;i++)h=(h<<16)+S[i],h-=(R=Math.floor(h/E))*E,(0<p.length||0<R)&&(p[p.length]=R);C[C.length]=h,S=p}var v="";for(i=C.length-1;0<=i;i--)v+=l.charAt(C[i]);var M=Math.ceil(8*s.length/(Math.log(l.length)/Math.log(2)));for(i=v.length;i<M;i++)v=l[0]+v;return v}function c(s){for(var l,i,R="",h=-1;++h<s.length;)l=s.charCodeAt(h),i=h+1<s.length?s.charCodeAt(h+1):0,55296<=l&&l<=56319&&56320<=i&&i<=57343&&(l=65536+((1023&l)<<10)+(1023&i),h++),l<=127?R+=String.fromCharCode(l):l<=2047?R+=String.fromCharCode(192|l>>>6&31,128|63&l):l<=65535?R+=String.fromCharCode(224|l>>>12&15,128|l>>>6&63,128|63&l):l<=2097151&&(R+=String.fromCharCode(240|l>>>18&7,128|l>>>12&63,128|l>>>6&63,128|63&l));return R}function y(s){for(var l=Array(s.length>>2),i=0;i<l.length;i++)l[i]=0;for(i=0;i<8*s.length;i+=8)l[i>>5]|=(255&s.charCodeAt(i/8))<<24-i%32;return l}function g(s){for(var l="",i=0;i<32*s.length;i+=8)l+=String.fromCharCode(s[i>>5]>>>24-i%32&255);return l}function d(s,l){s[l>>5]|=128<<24-l%32,s[15+(l+64>>9<<4)]=l;for(var i,R=Array(80),h=1732584193,p=-271733879,E=-1732584194,C=271733878,S=-1009589776,v=0;v<s.length;v+=16){for(var M=h,N=p,q=E,w=C,B=S,_=0;_<80;_++){R[_]=_<16?s[v+_]:O(R[_-3]^R[_-8]^R[_-14]^R[_-16],1);var H=T(T(O(h,5),A(_,p,E,C)),T(T(S,R[_]),(i=_)<20?1518500249:i<40?1859775393:i<60?-1894007588:-899497514));S=C,C=E,E=O(p,30),p=h,h=H}h=T(h,M),p=T(p,N),E=T(E,q),C=T(C,w),S=T(S,B)}return Array(h,p,E,C,S)}function A(s,l,i,R){return s<20?l&i|~l&R:s<40?l^i^R:s<60?l&i|l&R|i&R:l^i^R}function T(s,l){var i=(65535&s)+(65535&l);return(s>>16)+(l>>16)+(i>>16)<<16|65535&i}function O(s,l){return s<<l|s>>>32-l}t.hex_sha1=a,t.b64_sha1=function(s){return o(e(c(s)))},t.any_sha1=function(s,l){return u(e(c(s)),l)},t.hex_hmac_sha1=function(s,l){return n(r(c(s),c(l)))},t.b64_hmac_sha1=function(s,l){return o(r(c(s),c(l)))},t.any_hmac_sha1=function(s,l,i){return u(r(c(s),c(l)),i)}}(P||(P={})),function(t){var m=function(){function f(){}return f.networkRequest=function(a){t.Platform.log("WXHelper networkRequest, parameter:"),t.Platform.log(a),wx.request({url:a.url,data:a.data,header:a.header,method:a.method,dataType:a.dataType,success:function(e){t.Platform.log("WXHelper networkRequest, complete:"),t.Platform.log(e),a.callback&&(e.statusCode!=200?(t.Platform.error("WXHelper networkRequest, fail: Code:"+e.statusCode),a.callback(!1,e,e.statusCode,e.header)):e.data?(t.Platform.log("WXHelper networkRequest, success."),a.callback(!0,e.data,e.statusCode,e.header)):(t.Platform.error("WXHelper networkRequest, fail:"),t.Platform.error(e),a.callback(!1,e,e.statusCode,e.header)))},fail:function(){t.Platform.error("WXHelper networkRequest, fail"),a.callback&&a.callback(!1,null,-1,null)}})},f.getStorageSync=function(a){return wx.getStorageSync(a)},f.setStorageSync=function(a,e){return wx.setStorageSync(a,e)},f.setStorage=function(a,e,r){wx.setStorage({key:a,data:e,success:function(){r&&r(!0)},fail:function(){r&&r(!1)}})},f.getStorage=function(a,e){wx.getStorage({key:a,success:function(r){e&&e(r)},fail:function(){e&&e(null)}})},f}();t.WXHelper=m}(P||(P={}));
