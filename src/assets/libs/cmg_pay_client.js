(function(){(function(){(function(){(function(){var q=function(O,P){return function(){return P||O((P={exports:{}}).exports,P),P.exports}},w=q(function(O){var P,B=O&&O.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,f){m.__proto__=f}||function(m,f){for(var a in f)f.hasOwnProperty(a)&&(m[a]=f[a])};return function(m,f){function a(){this.constructor=m}e(m,f),m.prototype=f===null?Object.create(f):(a.prototype=f.prototype,new a)}}();(function(e){var m=function(){function a(){}return a.SUCESS=0,a.NOT_INIT=-1,a.PARAMETER_INVALIDATE=-2,a.SERVER_NET_ERROR=-3,a.SERVER_ERROR_PRE_TRADE=-4,a.SERVER_ERROR_PAY=-5,a.SERVER_ERROR_PERPAY=-6,a.MIDAS_ERROR=-7,a.SERVER_ERROR_CHECK_BALANCE=-8,a.SERVER_ERROR_CHECK_BALANCE_MISMATCH=-9,a.SERVER_ERROR_BUY_HONOR_NOT_EXIST=-10,a}();e.ClientPayCode=m;var f=function(){function a(){}return a.prototype.init=function(t,r,n,o,u,c){c===void 0&&(c=!1),c&&(r=e.Platform.PLATFORM_WECHAT_TEST,e.Platform.isPrintLog=!0),e.Platform.log("Client::init gameId("+t+") platform("+r+")"),this.mDataManager=new e.PayManager(t,r,n,o),this.mDataManager.init(u)},a.prototype.consume=function(t,r,n,o){this.mDataManager!=null?this.mDataManager.consume(t,r,n,o):o(m.NOT_INIT,null)},a.prototype.present=function(t,r,n,o){this.mDataManager!=null?this.mDataManager.present(t,r,n,o):o(m.NOT_INIT,null)},a.prototype.getBalance=function(t){this.mDataManager!=null?this.mDataManager.getBalance(t):t(m.NOT_INIT,null)},a.prototype.recharge=function(t,r){this.mDataManager!=null?this.mDataManager.recharge(t,r):r(e.RechargeResponse.create(e.RechargeStage.PERPAY,m.NOT_INIT))},a.prototype.getHistroyTrade=function(t,r,n){this.mDataManager!=null?this.mDataManager.getHistroyTrade(t,r,n):n(m.NOT_INIT,null)},a.prototype.buyHonor=function(t,r){this.mDataManager!=null?this.mDataManager.buyHonor(t,r):r(m.NOT_INIT,null)},a.prototype.destroy=function(t){e.Platform.log("Client::destroy"),this.mDataManager&&this.mDataManager.destroy(t)},a}();e.Client=f,e.client=new f})(P||(P={})),function(e){var m=function(){function r(){}return r.PERPAY="request_perpay",r.PAY="request_pay",r.CHECK_PAY="request_check_pay",r}();e.RechargeStage=m;var f=function(){function r(){}return r.prototype.isUserCancel=function(){return this.midasErrCode!=null&&(this.midasErrCode==-2||this.midasErrCode==1)},r.create=function(n,o,u){var c=new r;return c.stage=n,c.resultCode=o,c.result=o==e.ClientPayCode.SUCESS,c.balancInfo=u,c},r.createMidas=function(n,o,u){var c=new r;return c.stage=m.PAY,c.resultCode=n,c.result=n==e.ClientPayCode.SUCESS,c.midasErrMsg=o,c.midasErrCode=u,c},r}();e.RechargeResponse=f;var a=function(){function r(){}return r.createSimpleBalance=function(n){var o=new r;return o.balance=n,o},r.parseServerJson=function(n){var o=new r;return o.balance=n.balance,o.presentedBalance=n.gen_balance,o.firstPay=n.first_save,o.paySum=n.save_amt,o.totalSum=n.save_sum,o.costSum=n.cost_sum,o.presentSum=n.present_sum,o},r.prototype.toString=function(){return console.log("toString called "),""},r}();e.BalanceInfo=a;var t=function(){function r(){}return r.parseServerJson=function(n){try{return a.parseServerJson(n)}catch(o){e.Platform.error(o)}return null},r}();e.BalanceInfoParser=t}((window.cmgPay=P)||(P={})),function(e){var m=function(){function f(a,t,r,n){this.mOfferId="1450015698",this.mPlatform=e.Platform.createInstance(a,t,r,n),this.mNetRequester=new e.PayNetRequester(this.mPlatform)}return f.prototype.init=function(a){a(e.ClientPayCode.SUCESS)},f.prototype.destroy=function(a){a(e.ClientPayCode.SUCESS)},f.prototype.consume=function(a,t,r,n){var o=this;this.mNetRequester.pretrade(function(u,c){u==e.ClientPayCode.SUCESS?o.mNetRequester.pay(c,a,t,r,function(h,g){h==e.ClientPayCode.SUCESS?n(h,e.BalanceInfo.createSimpleBalance(g)):n(e.ClientPayCode.SERVER_ERROR_PAY,null)}):n(e.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.present=function(a,t,r,n){var o=this;this.mNetRequester.pretrade(function(u,c){u==e.ClientPayCode.SUCESS?o.mNetRequester.present(c,a,t,r,function(h,g){h==e.ClientPayCode.SUCESS?n(h,e.BalanceInfo.createSimpleBalance(g)):n(e.ClientPayCode.SERVER_ERROR_PAY,null)}):n(e.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.getBalance=function(a){this.mNetRequester.getBalance(a)},f.prototype.recharge=function(a,t){var r=this,n=this.getLocalBillNo();this.mNetRequester.perpay(n,a,function(o,u,c,h){o==e.ClientPayCode.SUCESS?(e.Platform.log("perpay: localBillNo "+u+", serverBillNo: "+c+", balance: "+h),t(e.RechargeResponse.create(e.RechargeStage.PERPAY,e.ClientPayCode.SUCESS)),r.requestMidasPayment(a,h,t)):t(e.RechargeResponse.create(e.RechargeStage.PERPAY,e.ClientPayCode.SERVER_ERROR_PERPAY))})},f.prototype.getLocalBillNo=function(){return"midas-"+new Date().getTime()},f.prototype.requestMidasPayment=function(a,t,r){var n=this,o={mode:"game",offerId:this.mOfferId,buyQuantity:a,zoneId:"1",platform:"android",env:0,currencyType:"CNY",success:function(){e.Platform.log("requestMidasPayment success "),r(e.RechargeResponse.createMidas(e.ClientPayCode.SUCESS)),n.checkBalance(t,r)},fail:function(u){var c=u.errMsg,h=u.errCode;e.Platform.log("requestMidasPayment fail"),console.error(c,h),r(e.RechargeResponse.createMidas(e.ClientPayCode.MIDAS_ERROR,c,h))},complete:function(){e.Platform.log("requestMidasPayment complete called ")}};e.Platform.log("requestMidasPayment called!!!! "),e.Platform.log(o);try{wx.requestMidasPayment(o)}catch(u){e.Platform.log("wx.requestMidasPayment catch e "),r(e.RechargeResponse.createMidas(e.ClientPayCode.MIDAS_ERROR,"requestMidasPayment catch error",-19800)),e.Platform.log(u)}e.Platform.log("requestMidasPayment called end !!!! ")},f.prototype.checkBalance=function(a,t){this.mNetRequester.getBalance(function(r,n){r==e.ClientPayCode.SUCESS?(e.Platform.log("checkBalance success preBlance: "+a+", current blance: "+n.balance),n.preBalance=a,n.balance<=a?t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SERVER_ERROR_CHECK_BALANCE_MISMATCH,n)):t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SUCESS,n))):t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SERVER_ERROR_CHECK_BALANCE))})},f.prototype.getHistroyTrade=function(a,t,r){this.mNetRequester.getHistroyTrade(a,t,r)},f.prototype.buyHonor=function(a,t){this.mNetRequester.buyHonor(a,t)},f}();e.PayManager=m}(P||(P={})),function(e){var m=function(){function f(a){this.urlPerpay="payment/midas/prepay",this.urlGetBalance="payment/midas/balance/get",this.urlPretrade="payment/midas/pretrade",this.urlPay="payment/midas/pay",this.urlGetHistoryTrade="payment/midas/trade_history",this.urlPresent="payment/midas/present",this.urlBuyHonor="userinfo/honor/buy",this.mPlatform=a,this.urlPerpay=this.mPlatform.getBaseServerUrl()+this.urlPerpay,this.urlGetBalance=this.mPlatform.getBaseServerUrl()+this.urlGetBalance,this.urlPretrade=this.mPlatform.getBaseServerUrl()+this.urlPretrade,this.urlPay=this.mPlatform.getBaseServerUrl()+this.urlPay,this.urlGetHistoryTrade=this.mPlatform.getBaseServerUrl()+this.urlGetHistoryTrade,this.urlPresent=this.mPlatform.getBaseServerUrl()+this.urlPresent,this.urlBuyHonor=this.mPlatform.getBaseServerUrl()+this.urlBuyHonor}return f.prototype.perpay=function(a,t,r){var n={local_bill_no:a,amount:t};this.mPlatform.netwrokRequest(this.urlPerpay,n,function(o,u){e.Platform.log("PayNetRequester#perpay#result: "+o),e.Platform.log(u);var c=o?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;o&&u!=null&&u.local_bill_no==a&&u.bill_no!=0?r(c,u.local_bill_no,u.bill_no,u.balance):r(e.ClientPayCode.SERVER_NET_ERROR,a,"",0)})},f.prototype.getBalance=function(a){this.mPlatform.netwrokRequest(this.urlGetBalance,{},function(t,r){e.Platform.log("PayNetRequester#getBalance#result: "+t),e.Platform.log(r);var n=t?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;if(t&&r!=null){var o=e.BalanceInfoParser.parseServerJson(r);o!=null?a(n,o):a(e.ClientPayCode.SERVER_NET_ERROR,null)}else a(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pretrade=function(a){this.mPlatform.netwrokRequest(this.urlPretrade,{},function(t,r){e.Platform.log("PayNetRequester#pretrade#result: "+t),e.Platform.log(r);var n=t?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;t&&r!=null&&r.bill_no!=null?a(n,r.bill_no):a(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pay=function(a,t,r,n,o){var u={amt:t,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPay,u,function(c,h){e.Platform.log("PayNetRequester#pay#result: "+c),e.Platform.log(h);var g=c?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;c&&h!=null&&h.balance!=null?o(g,h.balance):o(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.present=function(a,t,r,n,o){var u={amt:t,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPresent,u,function(c,h){e.Platform.log("PayNetRequester#present#result: "+c),e.Platform.log(h);var g=c?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;c&&h!=null&&h.balance!=null?o(g,h.balance):o(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.getHistroyTrade=function(a,t,r){var n={begin_time:Math.floor(a/1e3),end_time:Math.floor(t/1e3)};this.mPlatform.netwrokRequest(this.urlGetHistoryTrade,n,function(o,u){e.Platform.log("PayNetRequester#getHistroyTrade#result: "+o),e.Platform.log(u);var c=o?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;o&&u!=null?r(c,0):r(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.buyHonor=function(a,t){var r={item_id:a};this.mPlatform.netwrokRequest(this.urlBuyHonor,r,function(n,o){if(e.Platform.log("PayNetRequester#buyHonor#result: "+n),e.Platform.log(o),o&&o.status){var u=null;if(o.infos)try{u=JSON.parse(o.infos)}catch(A){}if(!u)return e.Platform.log("PayNetRequester#buyHonor#dataInfo parse error"),void t(o.status,null);var c=new Map;for(var h in u)u.hasOwnProperty(h)&&(g=u[h])!=null&&c.set(h,g);var g,d=o.status;d==e.ClientPayCode.SUCESS&&((g=c.get(a))==null||g==null||g<=0)&&(e.Platform.log("PayNetRequester#buyHonor#cannot find itemId"),d=e.ClientPayCode.SERVER_ERROR_BUY_HONOR_NOT_EXIST),t(d,c)}else t(e.ClientPayCode.SERVER_NET_ERROR,null)})},f}();e.PayNetRequester=m}(P||(P={})),function(e){var m=function(){function t(){var r=window.getQueryStringRegion("region");this.SERVER_ADDRESS_BASE=r=="oversea"?"https://h5game_oversea.cmcm.com/warty/":"https://minigame.cmcm.com/warty/"}return t.prototype.networkRequest=function(r){e.WXHelper.networkRequest(r)},t.prototype.getBaseServerUrl=function(){return this.SERVER_ADDRESS_BASE},t.prototype.getStorageSync=function(r){return e.WXHelper.getStorageSync(r)},t.prototype.setStorageSync=function(r,n){e.WXHelper.setStorageSync(r,n)},t}(),f=function(t){function r(){return t!==null&&t.apply(this,arguments)||this}return B(r,t),r.prototype.getBaseServerUrl=function(){return"https://pianotiles-minigame.cmcm.com/warty/"},r}(m),a=function(){function t(r,n,o,u){this.mTimeDiffLocal=0,this.mPlatformType=n,this.mGameId=r,this.mPlayerId=o,this.mToken=u,this.initPlatform(this.mPlatformType)}return t.createInstance=function(r,n,o,u){return new t(r,n,o,u)},t.log=function(r){t.isPrintLog&&console.warn(r)},t.error=function(r){console.error(r)},t.prototype.initPlatform=function(r){switch(r){case t.PLATFORM_WECHAT:case t.PLATFORM_H5SDK:this.mPlatformProxy=new m;break;case t.PLATFORM_WECHAT_TEST:default:this.mPlatformProxy=new f}},t.prototype.getBaseServerUrl=function(){return this.mPlatformProxy.getBaseServerUrl()},t.prototype.netwrokRequest=function(r,n,o,u){var c=this;u===void 0&&(u=t.IO_TRY_TIMES_MAX),t.log("#### netwrokRequest tryTime "+u),n.playerid=this.mPlayerId,n.timestamp=new Date().getTime(),n.gameid=this.mGameId;var h="CMCM "+e.hex_hmac_sha1(this.mToken,JSON.stringify(n));this.doNetworkRequest({url:r,data:n,header:{Authorization:h},method:t.METHOD_POST,dataType:"string",callback:function(g,d){u-=1,g==0&&0<u?c.netwrokRequest(r,n,o,u):o(g,d)}})},t.prototype.getCurrentServerTime=function(){var r=new Date().getTime()-this.mTimeDiffLocal;return t.log("getServerTime:"+r),r},t.prototype.refleshLocalTimeDiff=function(r){this.mTimeDiffLocal=new Date().getTime()-r},t.prototype.doNetworkRequest=function(r){var n=this;this.mPlatformProxy.networkRequest({url:r.url,data:r.data,header:r.header,method:r.method,dataType:r.dataType,callback:function(o,u,c,h){var g=null;if(o){g=JSON.parse(u),n.refleshLocalTimeDiff(1e3*g.timestamp);var d=h.Authorization?h.Authorization:h.authorization;if(!h||!d)return t.error("networkRequest, fail: Authorization is empty."),void r.callback(!1,g);var A=n.mToken;if(!A)return t.error("networkRequest, Local token is empty"),void r.callback(!1,null);if("CMCM "+e.hex_hmac_sha1(A,u)!==d)return t.error("networkRequest, fail: Invalid authorization."),void r.callback(!1,null);t.log("networkRequest, The authorization is right.")}r.callback(o,g)}})},t.prototype.getLocalStorage=function(r){for(var n=0;n<t.IO_TRY_TIMES_MAX;n++)try{return this.mPlatformProxy.getStorageSync(r)}catch(o){t.error(o)}},t.prototype.setLocalStorage=function(r,n){for(var o=0;o<t.IO_TRY_TIMES_MAX;o++)try{return this.mPlatformProxy.setStorageSync(r,n)}catch(u){t.error(u)}},t.PLATFORM_WEB=0,t.PLATFORM_WECHAT=1,t.PLATFORM_FACEBOOK=2,t.PLATFORM_H5SDK=3,t.PLATFORM_QQPLAY=4,t.PLATFORM_WECHAT_TEST=101,t.isPrintLog=!0,t.METHOD_POST="POST",t.IO_TRY_TIMES_MAX=3,t}();e.Platform=a}(P||(P={})),function(e){var m=0,f="";function a(s){return n(t(c(s)))}function t(s){return g(d(h(s),8*s.length))}function r(s,l){var i=h(s);16<i.length&&(i=d(i,8*s.length));for(var R=Array(16),y=Array(16),p=0;p<16;p++)R[p]=909522486^i[p],y[p]=1549556828^i[p];var E=d(R.concat(h(l)),512+8*l.length);return g(d(y.concat(E),672))}function n(s){for(var l,i=m?"0123456789ABCDEF":"0123456789abcdef",R="",y=0;y<s.length;y++)l=s.charCodeAt(y),R+=i.charAt(l>>>4&15)+i.charAt(15&l);return R}function o(s){for(var l="",i=s.length,R=0;R<i;R+=3)for(var y=s.charCodeAt(R)<<16|(R+1<i?s.charCodeAt(R+1)<<8:0)|(R+2<i?s.charCodeAt(R+2):0),p=0;p<4;p++)8*R+6*p>8*s.length?l+=f:l+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(y>>>6*(3-p)&63);return l}function u(s,l){var i,R,y,p,E=l.length,C=Array(),S=Array(Math.ceil(s.length/2));for(i=0;i<S.length;i++)S[i]=s.charCodeAt(2*i)<<8|s.charCodeAt(2*i+1);for(;0<S.length;){for(p=Array(),i=y=0;i<S.length;i++)y=(y<<16)+S[i],y-=(R=Math.floor(y/E))*E,(0<p.length||0<R)&&(p[p.length]=R);C[C.length]=y,S=p}var v="";for(i=C.length-1;0<=i;i--)v+=l.charAt(C[i]);var N=Math.ceil(8*s.length/(Math.log(l.length)/Math.log(2)));for(i=v.length;i<N;i++)v=l[0]+v;return v}function c(s){for(var l,i,R="",y=-1;++y<s.length;)l=s.charCodeAt(y),i=y+1<s.length?s.charCodeAt(y+1):0,55296<=l&&l<=56319&&56320<=i&&i<=57343&&(l=65536+((1023&l)<<10)+(1023&i),y++),l<=127?R+=String.fromCharCode(l):l<=2047?R+=String.fromCharCode(192|l>>>6&31,128|63&l):l<=65535?R+=String.fromCharCode(224|l>>>12&15,128|l>>>6&63,128|63&l):l<=2097151&&(R+=String.fromCharCode(240|l>>>18&7,128|l>>>12&63,128|l>>>6&63,128|63&l));return R}function h(s){for(var l=Array(s.length>>2),i=0;i<l.length;i++)l[i]=0;for(i=0;i<8*s.length;i+=8)l[i>>5]|=(255&s.charCodeAt(i/8))<<24-i%32;return l}function g(s){for(var l="",i=0;i<32*s.length;i+=8)l+=String.fromCharCode(s[i>>5]>>>24-i%32&255);return l}function d(s,l){s[l>>5]|=128<<24-l%32,s[15+(l+64>>9<<4)]=l;for(var i,R=Array(80),y=1732584193,p=-271733879,E=-1732584194,C=271733878,S=-1009589776,v=0;v<s.length;v+=16){for(var N=y,b=p,H=E,k=C,I=S,_=0;_<80;_++){R[_]=_<16?s[v+_]:M(R[_-3]^R[_-8]^R[_-14]^R[_-16],1);var D=T(T(M(y,5),A(_,p,E,C)),T(T(S,R[_]),(i=_)<20?1518500249:i<40?1859775393:i<60?-1894007588:-899497514));S=C,C=E,E=M(p,30),p=y,y=D}y=T(y,N),p=T(p,b),E=T(E,H),C=T(C,k),S=T(S,I)}return Array(y,p,E,C,S)}function A(s,l,i,R){return s<20?l&i|~l&R:s<40?l^i^R:s<60?l&i|l&R|i&R:l^i^R}function T(s,l){var i=(65535&s)+(65535&l);return(s>>16)+(l>>16)+(i>>16)<<16|65535&i}function M(s,l){return s<<l|s>>>32-l}e.hex_sha1=a,e.b64_sha1=function(s){return o(t(c(s)))},e.any_sha1=function(s,l){return u(t(c(s)),l)},e.hex_hmac_sha1=function(s,l){return n(r(c(s),c(l)))},e.b64_hmac_sha1=function(s,l){return o(r(c(s),c(l)))},e.any_hmac_sha1=function(s,l,i){return u(r(c(s),c(l)),i)}}(P||(P={})),function(e){var m=function(){function f(){}return f.networkRequest=function(a){e.Platform.log("WXHelper networkRequest, parameter:"),e.Platform.log(a),wx.request({url:a.url,data:a.data,header:a.header,method:a.method,dataType:a.dataType,success:function(t){e.Platform.log("WXHelper networkRequest, complete:"),e.Platform.log(t),a.callback&&(t.statusCode!=200?(e.Platform.error("WXHelper networkRequest, fail: Code:"+t.statusCode),a.callback(!1,t,t.statusCode,t.header)):t.data?(e.Platform.log("WXHelper networkRequest, success."),a.callback(!0,t.data,t.statusCode,t.header)):(e.Platform.error("WXHelper networkRequest, fail:"),e.Platform.error(t),a.callback(!1,t,t.statusCode,t.header)))},fail:function(){e.Platform.error("WXHelper networkRequest, fail"),a.callback&&a.callback(!1,null,-1,null)}})},f.getStorageSync=function(a){return wx.getStorageSync(a)},f.setStorageSync=function(a,t){return wx.setStorageSync(a,t)},f.setStorage=function(a,t,r){wx.setStorage({key:a,data:t,success:function(){r&&r(!0)},fail:function(){r&&r(!1)}})},f.getStorage=function(a,t){wx.getStorage({key:a,success:function(r){t&&t(r)},fail:function(){t&&t(null)}})},f}();e.WXHelper=m}(P||(P={}))});w()})()})()})();})();
