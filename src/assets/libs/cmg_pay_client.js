(function(){(function(){(function(){var q=function(M,p){return function(){return p||M((p={exports:{}}).exports,p),p.exports}},w=q(function(M){var p,B=M&&M.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,f){h.__proto__=f}||function(h,f){for(var a in f)f.hasOwnProperty(a)&&(h[a]=f[a])};return function(h,f){function a(){this.constructor=h}e(h,f),h.prototype=f===null?Object.create(f):(a.prototype=f.prototype,new a)}}();(function(e){var h=function(){function a(){}return a.SUCESS=0,a.NOT_INIT=-1,a.PARAMETER_INVALIDATE=-2,a.SERVER_NET_ERROR=-3,a.SERVER_ERROR_PRE_TRADE=-4,a.SERVER_ERROR_PAY=-5,a.SERVER_ERROR_PERPAY=-6,a.MIDAS_ERROR=-7,a.SERVER_ERROR_CHECK_BALANCE=-8,a.SERVER_ERROR_CHECK_BALANCE_MISMATCH=-9,a.SERVER_ERROR_BUY_HONOR_NOT_EXIST=-10,a}();e.ClientPayCode=h;var f=function(){function a(){}return a.prototype.init=function(t,r,n,o,s,c){c===void 0&&(c=!1),c&&(r=e.Platform.PLATFORM_WECHAT_TEST,e.Platform.isPrintLog=!0),e.Platform.log("Client::init gameId("+t+") platform("+r+")"),this.mDataManager=new e.PayManager(t,r,n,o),this.mDataManager.init(s)},a.prototype.consume=function(t,r,n,o){this.mDataManager!=null?this.mDataManager.consume(t,r,n,o):o(h.NOT_INIT,null)},a.prototype.present=function(t,r,n,o){this.mDataManager!=null?this.mDataManager.present(t,r,n,o):o(h.NOT_INIT,null)},a.prototype.getBalance=function(t){this.mDataManager!=null?this.mDataManager.getBalance(t):t(h.NOT_INIT,null)},a.prototype.recharge=function(t,r){this.mDataManager!=null?this.mDataManager.recharge(t,r):r(e.RechargeResponse.create(e.RechargeStage.PERPAY,h.NOT_INIT))},a.prototype.getHistroyTrade=function(t,r,n){this.mDataManager!=null?this.mDataManager.getHistroyTrade(t,r,n):n(h.NOT_INIT,null)},a.prototype.buyHonor=function(t,r){this.mDataManager!=null?this.mDataManager.buyHonor(t,r):r(h.NOT_INIT,null)},a.prototype.destroy=function(t){e.Platform.log("Client::destroy"),this.mDataManager&&this.mDataManager.destroy(t)},a}();e.Client=f,e.client=new f})(p||(p={})),function(e){var h=function(){function r(){}return r.PERPAY="request_perpay",r.PAY="request_pay",r.CHECK_PAY="request_check_pay",r}();e.RechargeStage=h;var f=function(){function r(){}return r.prototype.isUserCancel=function(){return this.midasErrCode!=null&&(this.midasErrCode==-2||this.midasErrCode==1)},r.create=function(n,o,s){var c=new r;return c.stage=n,c.resultCode=o,c.result=o==e.ClientPayCode.SUCESS,c.balancInfo=s,c},r.createMidas=function(n,o,s){var c=new r;return c.stage=h.PAY,c.resultCode=n,c.result=n==e.ClientPayCode.SUCESS,c.midasErrMsg=o,c.midasErrCode=s,c},r}();e.RechargeResponse=f;var a=function(){function r(){}return r.createSimpleBalance=function(n){var o=new r;return o.balance=n,o},r.parseServerJson=function(n){var o=new r;return o.balance=n.balance,o.presentedBalance=n.gen_balance,o.firstPay=n.first_save,o.paySum=n.save_amt,o.totalSum=n.save_sum,o.costSum=n.cost_sum,o.presentSum=n.present_sum,o},r.prototype.toString=function(){return console.log("toString called "),""},r}();e.BalanceInfo=a;var t=function(){function r(){}return r.parseServerJson=function(n){try{return a.parseServerJson(n)}catch(o){e.Platform.error(o)}return null},r}();e.BalanceInfoParser=t}((window.cmgPay=p)||(p={})),function(e){var h=function(){function f(a,t,r,n){this.mOfferId="1450015698",this.mPlatform=e.Platform.createInstance(a,t,r,n),this.mNetRequester=new e.PayNetRequester(this.mPlatform)}return f.prototype.init=function(a){a(e.ClientPayCode.SUCESS)},f.prototype.destroy=function(a){a(e.ClientPayCode.SUCESS)},f.prototype.consume=function(a,t,r,n){var o=this;this.mNetRequester.pretrade(function(s,c){s==e.ClientPayCode.SUCESS?o.mNetRequester.pay(c,a,t,r,function(R,g){R==e.ClientPayCode.SUCESS?n(R,e.BalanceInfo.createSimpleBalance(g)):n(e.ClientPayCode.SERVER_ERROR_PAY,null)}):n(e.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.present=function(a,t,r,n){var o=this;this.mNetRequester.pretrade(function(s,c){s==e.ClientPayCode.SUCESS?o.mNetRequester.present(c,a,t,r,function(R,g){R==e.ClientPayCode.SUCESS?n(R,e.BalanceInfo.createSimpleBalance(g)):n(e.ClientPayCode.SERVER_ERROR_PAY,null)}):n(e.ClientPayCode.SERVER_ERROR_PRE_TRADE,null)})},f.prototype.getBalance=function(a){this.mNetRequester.getBalance(a)},f.prototype.recharge=function(a,t){var r=this,n=this.getLocalBillNo();this.mNetRequester.perpay(n,a,function(o,s,c,R){o==e.ClientPayCode.SUCESS?(e.Platform.log("perpay: localBillNo "+s+", serverBillNo: "+c+", balance: "+R),t(e.RechargeResponse.create(e.RechargeStage.PERPAY,e.ClientPayCode.SUCESS)),r.requestMidasPayment(a,R,t)):t(e.RechargeResponse.create(e.RechargeStage.PERPAY,e.ClientPayCode.SERVER_ERROR_PERPAY))})},f.prototype.getLocalBillNo=function(){return"midas-"+new Date().getTime()},f.prototype.requestMidasPayment=function(a,t,r){var n=this,o={mode:"game",offerId:this.mOfferId,buyQuantity:a,zoneId:"1",platform:"android",env:0,currencyType:"CNY",success:function(){e.Platform.log("requestMidasPayment success "),r(e.RechargeResponse.createMidas(e.ClientPayCode.SUCESS)),n.checkBalance(t,r)},fail:function(s){var c=s.errMsg,R=s.errCode;e.Platform.log("requestMidasPayment fail"),console.error(c,R),r(e.RechargeResponse.createMidas(e.ClientPayCode.MIDAS_ERROR,c,R))},complete:function(){e.Platform.log("requestMidasPayment complete called ")}};e.Platform.log("requestMidasPayment called!!!! "),e.Platform.log(o);try{wx.requestMidasPayment(o)}catch(s){e.Platform.log("wx.requestMidasPayment catch e "),r(e.RechargeResponse.createMidas(e.ClientPayCode.MIDAS_ERROR,"requestMidasPayment catch error",-19800)),e.Platform.log(s)}e.Platform.log("requestMidasPayment called end !!!! ")},f.prototype.checkBalance=function(a,t){this.mNetRequester.getBalance(function(r,n){r==e.ClientPayCode.SUCESS?(e.Platform.log("checkBalance success preBlance: "+a+", current blance: "+n.balance),n.preBalance=a,n.balance<=a?t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SERVER_ERROR_CHECK_BALANCE_MISMATCH,n)):t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SUCESS,n))):t(e.RechargeResponse.create(e.RechargeStage.CHECK_PAY,e.ClientPayCode.SERVER_ERROR_CHECK_BALANCE))})},f.prototype.getHistroyTrade=function(a,t,r){this.mNetRequester.getHistroyTrade(a,t,r)},f.prototype.buyHonor=function(a,t){this.mNetRequester.buyHonor(a,t)},f}();e.PayManager=h}(p||(p={})),function(e){var h=function(){function f(a){this.urlPerpay="payment/midas/prepay",this.urlGetBalance="payment/midas/balance/get",this.urlPretrade="payment/midas/pretrade",this.urlPay="payment/midas/pay",this.urlGetHistoryTrade="payment/midas/trade_history",this.urlPresent="payment/midas/present",this.urlBuyHonor="userinfo/honor/buy",this.mPlatform=a,this.urlPerpay=this.mPlatform.getBaseServerUrl()+this.urlPerpay,this.urlGetBalance=this.mPlatform.getBaseServerUrl()+this.urlGetBalance,this.urlPretrade=this.mPlatform.getBaseServerUrl()+this.urlPretrade,this.urlPay=this.mPlatform.getBaseServerUrl()+this.urlPay,this.urlGetHistoryTrade=this.mPlatform.getBaseServerUrl()+this.urlGetHistoryTrade,this.urlPresent=this.mPlatform.getBaseServerUrl()+this.urlPresent,this.urlBuyHonor=this.mPlatform.getBaseServerUrl()+this.urlBuyHonor}return f.prototype.perpay=function(a,t,r){var n={local_bill_no:a,amount:t};this.mPlatform.netwrokRequest(this.urlPerpay,n,function(o,s){e.Platform.log("PayNetRequester#perpay#result: "+o),e.Platform.log(s);var c=o?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;o&&s!=null&&s.local_bill_no==a&&s.bill_no!=0?r(c,s.local_bill_no,s.bill_no,s.balance):r(e.ClientPayCode.SERVER_NET_ERROR,a,"",0)})},f.prototype.getBalance=function(a){this.mPlatform.netwrokRequest(this.urlGetBalance,{},function(t,r){e.Platform.log("PayNetRequester#getBalance#result: "+t),e.Platform.log(r);var n=t?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;if(t&&r!=null){var o=e.BalanceInfoParser.parseServerJson(r);o!=null?a(n,o):a(e.ClientPayCode.SERVER_NET_ERROR,null)}else a(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pretrade=function(a){this.mPlatform.netwrokRequest(this.urlPretrade,{},function(t,r){e.Platform.log("PayNetRequester#pretrade#result: "+t),e.Platform.log(r);var n=t?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;t&&r!=null&&r.bill_no!=null?a(n,r.bill_no):a(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.pay=function(a,t,r,n,o){var s={amt:t,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPay,s,function(c,R){e.Platform.log("PayNetRequester#pay#result: "+c),e.Platform.log(R);var g=c?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;c&&R!=null&&R.balance!=null?o(g,R.balance):o(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.present=function(a,t,r,n,o){var s={amt:t,pay_item:r,AppRemark:n,bill_no:a};this.mPlatform.netwrokRequest(this.urlPresent,s,function(c,R){e.Platform.log("PayNetRequester#present#result: "+c),e.Platform.log(R);var g=c?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;c&&R!=null&&R.balance!=null?o(g,R.balance):o(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.getHistroyTrade=function(a,t,r){var n={begin_time:Math.floor(a/1e3),end_time:Math.floor(t/1e3)};this.mPlatform.netwrokRequest(this.urlGetHistoryTrade,n,function(o,s){e.Platform.log("PayNetRequester#getHistroyTrade#result: "+o),e.Platform.log(s);var c=o?e.ClientPayCode.SUCESS:e.ClientPayCode.SERVER_NET_ERROR;o&&s!=null?r(c,0):r(e.ClientPayCode.SERVER_NET_ERROR,null)})},f.prototype.buyHonor=function(a,t){var r={item_id:a};this.mPlatform.netwrokRequest(this.urlBuyHonor,r,function(n,o){if(e.Platform.log("PayNetRequester#buyHonor#result: "+n),e.Platform.log(o),o&&o.status){var s=null;if(o.infos)try{s=JSON.parse(o.infos)}catch(A){}if(!s)return e.Platform.log("PayNetRequester#buyHonor#dataInfo parse error"),void t(o.status,null);var c=new Map;for(var R in s)s.hasOwnProperty(R)&&(g=s[R])!=null&&c.set(R,g);var g,d=o.status;d==e.ClientPayCode.SUCESS&&((g=c.get(a))==null||g==null||g<=0)&&(e.Platform.log("PayNetRequester#buyHonor#cannot find itemId"),d=e.ClientPayCode.SERVER_ERROR_BUY_HONOR_NOT_EXIST),t(d,c)}else t(e.ClientPayCode.SERVER_NET_ERROR,null)})},f}();e.PayNetRequester=h}(p||(p={})),function(e){var h=function(){function t(){var r=window.getQueryStringRegion("region");this.SERVER_ADDRESS_BASE=r=="oversea"?"https://h5game_oversea.cmcm.com/warty/":"https://minigame.cmcm.com/warty/"}return t.prototype.networkRequest=function(r){e.WXHelper.networkRequest(r)},t.prototype.getBaseServerUrl=function(){return this.SERVER_ADDRESS_BASE},t.prototype.getStorageSync=function(r){return e.WXHelper.getStorageSync(r)},t.prototype.setStorageSync=function(r,n){e.WXHelper.setStorageSync(r,n)},t}(),f=function(t){function r(){return t!==null&&t.apply(this,arguments)||this}return B(r,t),r.prototype.getBaseServerUrl=function(){return"https://pianotiles-minigame.cmcm.com/warty/"},r}(h),a=function(){function t(r,n,o,s){this.mTimeDiffLocal=0,this.mPlatformType=n,this.mGameId=r,this.mPlayerId=o,this.mToken=s,this.initPlatform(this.mPlatformType)}return t.createInstance=function(r,n,o,s){return new t(r,n,o,s)},t.log=function(r){t.isPrintLog&&console.warn(r)},t.error=function(r){console.error(r)},t.prototype.initPlatform=function(r){switch(r){case t.PLATFORM_WECHAT:case t.PLATFORM_H5SDK:this.mPlatformProxy=new h;break;case t.PLATFORM_WECHAT_TEST:default:this.mPlatformProxy=new f}},t.prototype.getBaseServerUrl=function(){return this.mPlatformProxy.getBaseServerUrl()},t.prototype.netwrokRequest=function(r,n,o,s){var c=this;s===void 0&&(s=t.IO_TRY_TIMES_MAX),t.log("#### netwrokRequest tryTime "+s),n.playerid=this.mPlayerId,n.timestamp=new Date().getTime(),n.gameid=this.mGameId;var R="CMCM "+e.hex_hmac_sha1(this.mToken,JSON.stringify(n));this.doNetworkRequest({url:r,data:n,header:{Authorization:R},method:t.METHOD_POST,dataType:"string",callback:function(g,d){s-=1,g==0&&0<s?c.netwrokRequest(r,n,o,s):o(g,d)}})},t.prototype.getCurrentServerTime=function(){var r=new Date().getTime()-this.mTimeDiffLocal;return t.log("getServerTime:"+r),r},t.prototype.refleshLocalTimeDiff=function(r){this.mTimeDiffLocal=new Date().getTime()-r},t.prototype.doNetworkRequest=function(r){var n=this;this.mPlatformProxy.networkRequest({url:r.url,data:r.data,header:r.header,method:r.method,dataType:r.dataType,callback:function(o,s,c,R){var g=null;if(o){g=JSON.parse(s),n.refleshLocalTimeDiff(1e3*g.timestamp);var d=R.Authorization?R.Authorization:R.authorization;if(!R||!d)return t.error("networkRequest, fail: Authorization is empty."),void r.callback(!1,g);var A=n.mToken;if(!A)return t.error("networkRequest, Local token is empty"),void r.callback(!1,null);if("CMCM "+e.hex_hmac_sha1(A,s)!==d)return t.error("networkRequest, fail: Invalid authorization."),void r.callback(!1,null);t.log("networkRequest, The authorization is right.")}r.callback(o,g)}})},t.prototype.getLocalStorage=function(r){for(var n=0;n<t.IO_TRY_TIMES_MAX;n++)try{return this.mPlatformProxy.getStorageSync(r)}catch(o){t.error(o)}},t.prototype.setLocalStorage=function(r,n){for(var o=0;o<t.IO_TRY_TIMES_MAX;o++)try{return this.mPlatformProxy.setStorageSync(r,n)}catch(s){t.error(s)}},t.PLATFORM_WEB=0,t.PLATFORM_WECHAT=1,t.PLATFORM_FACEBOOK=2,t.PLATFORM_H5SDK=3,t.PLATFORM_QQPLAY=4,t.PLATFORM_WECHAT_TEST=101,t.isPrintLog=!0,t.METHOD_POST="POST",t.IO_TRY_TIMES_MAX=3,t}();e.Platform=a}(p||(p={})),function(e){var h=0,f="";function a(u){return n(t(c(u)))}function t(u){return g(d(R(u),8*u.length))}function r(u,l){var i=R(u);16<i.length&&(i=d(i,8*u.length));for(var m=Array(16),y=Array(16),P=0;P<16;P++)m[P]=909522486^i[P],y[P]=1549556828^i[P];var E=d(m.concat(R(l)),512+8*l.length);return g(d(y.concat(E),672))}function n(u){for(var l,i=h?"0123456789ABCDEF":"0123456789abcdef",m="",y=0;y<u.length;y++)l=u.charCodeAt(y),m+=i.charAt(l>>>4&15)+i.charAt(15&l);return m}function o(u){for(var l="",i=u.length,m=0;m<i;m+=3)for(var y=u.charCodeAt(m)<<16|(m+1<i?u.charCodeAt(m+1)<<8:0)|(m+2<i?u.charCodeAt(m+2):0),P=0;P<4;P++)8*m+6*P>8*u.length?l+=f:l+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(y>>>6*(3-P)&63);return l}function s(u,l){var i,m,y,P,E=l.length,C=Array(),S=Array(Math.ceil(u.length/2));for(i=0;i<S.length;i++)S[i]=u.charCodeAt(2*i)<<8|u.charCodeAt(2*i+1);for(;0<S.length;){for(P=Array(),i=y=0;i<S.length;i++)y=(y<<16)+S[i],y-=(m=Math.floor(y/E))*E,(0<P.length||0<m)&&(P[P.length]=m);C[C.length]=y,S=P}var v="";for(i=C.length-1;0<=i;i--)v+=l.charAt(C[i]);var N=Math.ceil(8*u.length/(Math.log(l.length)/Math.log(2)));for(i=v.length;i<N;i++)v=l[0]+v;return v}function c(u){for(var l,i,m="",y=-1;++y<u.length;)l=u.charCodeAt(y),i=y+1<u.length?u.charCodeAt(y+1):0,55296<=l&&l<=56319&&56320<=i&&i<=57343&&(l=65536+((1023&l)<<10)+(1023&i),y++),l<=127?m+=String.fromCharCode(l):l<=2047?m+=String.fromCharCode(192|l>>>6&31,128|63&l):l<=65535?m+=String.fromCharCode(224|l>>>12&15,128|l>>>6&63,128|63&l):l<=2097151&&(m+=String.fromCharCode(240|l>>>18&7,128|l>>>12&63,128|l>>>6&63,128|63&l));return m}function R(u){for(var l=Array(u.length>>2),i=0;i<l.length;i++)l[i]=0;for(i=0;i<8*u.length;i+=8)l[i>>5]|=(255&u.charCodeAt(i/8))<<24-i%32;return l}function g(u){for(var l="",i=0;i<32*u.length;i+=8)l+=String.fromCharCode(u[i>>5]>>>24-i%32&255);return l}function d(u,l){u[l>>5]|=128<<24-l%32,u[15+(l+64>>9<<4)]=l;for(var i,m=Array(80),y=1732584193,P=-271733879,E=-1732584194,C=271733878,S=-1009589776,v=0;v<u.length;v+=16){for(var N=y,b=P,H=E,k=C,I=S,_=0;_<80;_++){m[_]=_<16?u[v+_]:O(m[_-3]^m[_-8]^m[_-14]^m[_-16],1);var D=T(T(O(y,5),A(_,P,E,C)),T(T(S,m[_]),(i=_)<20?1518500249:i<40?1859775393:i<60?-1894007588:-899497514));S=C,C=E,E=O(P,30),P=y,y=D}y=T(y,N),P=T(P,b),E=T(E,H),C=T(C,k),S=T(S,I)}return Array(y,P,E,C,S)}function A(u,l,i,m){return u<20?l&i|~l&m:u<40?l^i^m:u<60?l&i|l&m|i&m:l^i^m}function T(u,l){var i=(65535&u)+(65535&l);return(u>>16)+(l>>16)+(i>>16)<<16|65535&i}function O(u,l){return u<<l|u>>>32-l}e.hex_sha1=a,e.b64_sha1=function(u){return o(t(c(u)))},e.any_sha1=function(u,l){return s(t(c(u)),l)},e.hex_hmac_sha1=function(u,l){return n(r(c(u),c(l)))},e.b64_hmac_sha1=function(u,l){return o(r(c(u),c(l)))},e.any_hmac_sha1=function(u,l,i){return s(r(c(u),c(l)),i)}}(p||(p={})),function(e){var h=function(){function f(){}return f.networkRequest=function(a){e.Platform.log("WXHelper networkRequest, parameter:"),e.Platform.log(a),wx.request({url:a.url,data:a.data,header:a.header,method:a.method,dataType:a.dataType,success:function(t){e.Platform.log("WXHelper networkRequest, complete:"),e.Platform.log(t),a.callback&&(t.statusCode!=200?(e.Platform.error("WXHelper networkRequest, fail: Code:"+t.statusCode),a.callback(!1,t,t.statusCode,t.header)):t.data?(e.Platform.log("WXHelper networkRequest, success."),a.callback(!0,t.data,t.statusCode,t.header)):(e.Platform.error("WXHelper networkRequest, fail:"),e.Platform.error(t),a.callback(!1,t,t.statusCode,t.header)))},fail:function(){e.Platform.error("WXHelper networkRequest, fail"),a.callback&&a.callback(!1,null,-1,null)}})},f.getStorageSync=function(a){return wx.getStorageSync(a)},f.setStorageSync=function(a,t){return wx.setStorageSync(a,t)},f.setStorage=function(a,t,r){wx.setStorage({key:a,data:t,success:function(){r&&r(!0)},fail:function(){r&&r(!1)}})},f.getStorage=function(a,t){wx.getStorage({key:a,success:function(r){t&&t(r)},fail:function(){t&&t(null)}})},f}();e.WXHelper=h}(p||(p={}))});w()})()})();})();
